{{define "./views/room.html"}}
<!DOCTYPE html>
<!-- saved from url=(0071)http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html -->
<html class="js cssanimations"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		
		<title>基于meiziui的仿微信pc端</title>
		<link rel="stylesheet" href="/static/css/amazeui.min.css">
		<link rel="stylesheet" href="/static/css/main.css">
	</head>
	<body style="">
		<div class="box">
			<div class="wechat">
				
				<div class="sidestrip">
					<div class="am-dropdown" data-am-dropdown="">
						<!--头像插件-->
						<div class="own_head am-dropdown-toggle"></div>
						<div class="am-dropdown-content">
					    	<div class="own_head_top">
					    		<div class="own_head_top_text">
					    			<p class="own_name">彭于晏丶plus<img src="./head.png" alt=""></p>
					    			<p class="own_numb">微信号：jsk8787682</p>
					    		</div>
					    		<img src="/static/image/own_head.jpg" alt="">
					    	</div>
					    	<div class="own_head_bottom">
					    		<p><span>地区</span>江西 九江</p>
					    		<div class="own_head_bottom_img">
					    			<a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html"><img src="./head_1.png"></a>
					    			<a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html"><img src="./head_2.png"></a>
					    		</div>
					    	</div>
					  	</div>
					</div>
					<!--三图标-->
				  	<div class="sidestrip_icon">
				  		<a id="si_1" style="background: url(images/icon/head_2_1.png) no-repeat;"></a>
				  		<a id="si_2"></a>
				  		<a id="si_3"></a>
				  	</div>
				  	
				  	<!--底部扩展键-->
				  	<div id="doc-dropdown-justify-js">
				  		<div class="am-dropdown" id="doc-dropdown-js" style="position: initial;">
					  		<div class="sidestrip_bc am-dropdown-toggle"></div>
					  	    <ul class="am-dropdown-content" style="">
							    <li>
							    	<a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html#" data-am-modal="{target: &#39;#doc-modal-1&#39;, closeViaDimmer: 0, width: 400, height: 225}">意见反馈</a>
							    	<div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-1">
									  <div class="am-modal-dialog">
									    <div class="am-modal-hd">Modal 标题
									      <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close="">×</a>
									    </div>
									    <div class="am-modal-bd">
									      Modal 内容。本 Modal 无法通过遮罩层关闭。
									    </div>
									  </div>
									</div>
							    </li>
							    
							    <li><a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html#">备份与恢复</a></li>
							    <li><a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html#">设置</a></li>
						    </ul>
					    </div>	
					</div>	
				</div>
			    
			    <!--好友列表-->
				<div class="middle">
					<div class="wx_search">
						<input type="text" placeholder="搜索">
						<button>+</button>
					</div>
					<div class="office_text" style="overflow: hidden;">
						<ul class="friends_list" style="top: 0px; position: absolute;">
							<li>
								<p>新的朋友</p>
								<div class="friends_box">
									<div class="user_head"><img src="./1.jpg"></div>
									<div class="friends_text">
										<p class="user_name">新的朋友</p>
									</div>
								</div>
							</li>
							<li>
								<p>公众号</p>
								<div class="friends_box">
									<div class="user_head"><img src="./2.jpg"></div>
									<div class="friends_text">
										<p class="user_name">公众号</p>
									</div>
								</div>
							</li>
							<li>
								<p>A</p>
								<div class="friends_box">
									<div class="user_head"><img src="./3.jpg"></div>
									<div class="friends_text">
										<p class="user_name">彭于晏丶plus</p>
									</div>
								</div>
								<div class="friends_box">
									<div class="user_head"><img src="./4.jpg"></div>
									<div class="friends_text">
										<p class="user_name">陈依依</p>
									</div>
								</div>
								<div class="friends_box">
									<div class="user_head"><img src="./5.jpg"></div>
									<div class="friends_text">
										<p class="user_name">毛毛</p>
									</div>
								</div>
							</li>
							<li>
								<p>B</p>
								<div class="friends_box">
									<div class="user_head"><img src="./6.jpg"></div>
									<div class="friends_text">
										<p class="user_name">苏笑言</p>
									</div>
								</div>
								<div class="friends_box">
									<div class="user_head"><img src="./7.jpg"></div>
									<div class="friends_text">
										<p class="user_name">往事不再提</p>
									</div>
								</div>
							</li>
							<li>
								<p>C</p>
								<div class="friends_box">
									<div class="user_head"><img src="./8.jpg"></div>
									<div class="friends_text">
										<p class="user_name">夏继涛</p>
									</div>
								</div>
								<div class="friends_box">
									<div class="user_head"><img src="./9.jpg"></div>
									<div class="friends_text">
										<p class="user_name">早安无恙</p>
									</div>
								</div>
								<div class="friends_box">
									<div class="user_head"><img src="./10.jpg"></div>
									<div class="friends_text">
										<p class="user_name">王鹏</p>
									</div>
								</div>
							</li>
							<li>
								<p>D</p>
								<div class="friends_box">
									<div class="user_head"><img src="./11.jpg"></div>
									<div class="friends_text">
										<p class="user_name">涨了潮了</p>
									</div>
								</div>
								<div class="friends_box">
									<div class="user_head"><img src="./12.jpg"></div>
									<div class="friends_text">
										<p class="user_name">Ktz丶中融资</p>
									</div>
								</div>
							</li>
						</ul>
					<div style="position:absolute;display:none;line-height:0;" class="zUIpanelScrollBox"></div><div style="position: absolute; display: none; line-height: 0;" class="zUIpanelScrollBar"></div></div>	
				</div>
				
				<!--程序列表-->
				<div class="middle">
					<div class="wx_search">
						<input type="text" placeholder="搜索收藏内容">
						<button>+</button>
					</div>
					<div class="office_text" style="overflow: hidden;">
						<ul class="icon_list" style="top: 0px; position: absolute;">
							<li class="icon_active">
								<div class="icon"><img src="/static/image/icon.png" alt=""></div>
								<span>全部收藏</span>
							</li>
							<li>
								<div class="icon"><img src="/static/image/icon1.png" alt=""></div>
								<span>链接</span>
							</li>
							<li>
								<div class="icon"><img src="/static/image/icon2.png" alt=""></div>
								<span>相册</span>
							</li>
							<li>
								<div class="icon"><img src="/static/image/icon3.png" alt=""></div>
								<span>笔记</span>
							</li>
							<li>
								<div class="icon"><img src="/static/image/icon4.png" alt=""></div>
								<span>文件</span>
							</li>
							<li>
								<div class="icon"><img src="/static/image/icon5.png" alt=""></div>
								<span>音乐</span>
							</li>
							<li>
								<div class="icon"><img src="/static/image/icon6.png" alt=""></div>
								<span>标签</span>
							</li>
						</ul>
					<div style="position:absolute;display:none;line-height:0;" class="zUIpanelScrollBox"></div><div style="position: absolute; display: none; line-height: 0;" class="zUIpanelScrollBar"></div></div>	
				</div>
				<!--聊天列表-->
				<div class="middle on">
					<div class="wx_search">
						<input type="text" placeholder="搜索">
						<button>+</button>
					</div>
					<div class="office_text" style="overflow: hidden;">
						<ul id="user_list" class="user_list" style="top: 0px; position: absolute;">
							
						</ul>
					<div style="position: absolute; display: none; line-height: 0; height: 610px;" class="zUIpanelScrollBox"></div><div style="position: absolute; display: none; line-height: 0; height: 491px; top: 4px;" class="zUIpanelScrollBar"></div></div>	
				</div>
			    
				<!--聊天窗口-->
				<div class="talk_window">
					<div class="windows_top">
						<div class="windows_top_box">
							<span>{{ .RoomName }} </span>
							<span id="online_user_count">在线人数:0 </span>
							<ul class="window_icon">
								<li><a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html"><img src="/static/image/icon7.png"></a></li>
								<li><a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html"><img src="/static/image/icon8.png"></a></li>
								<li><a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html"><img src="/static/image/icon9.png"></a></li>
								<li><a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html"><img src="/static/image/icon10.png"></a></li>
							</ul>
							<div class="extend" data-am-offcanvas="{target: &#39;#doc-oc-demo3&#39;}"></div>
			
						</div>
					</div>
					
					<!--聊天内容-->
					<div class="windows_body">
						<div class="office_text" style="height: 100%; overflow: hidden;">
							<ul class="content" id="chatbox" style="top: 0px; position: absolute;">
							</ul>
						<div style="position: absolute; display: block; line-height: 0; height: 0px;" class="zUIpanelScrollBox"></div><div style="position: absolute; display: block; line-height: 0; height: 0px;" class="zUIpanelScrollBar"></div></div>
					</div>
					
					<div class="windows_input" id="talkbox">
						<div class="input_icon">
							<a href="javascript:;"></a>
							<a href="javascript:;"></a>
							<a href="javascript:;"></a>
							<a href="javascript:;"></a>
							<a href="javascript:;"></a>
							<a href="javascript:;"></a>
						</div>
						<div class="input_box">
							<textarea name="" rows="" cols="" id="input_box"></textarea>
							<button id="send">发送（S）</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		
	<script type="text/javascript" src="/static/js/jquery.min.js"></script>
	<script type="text/javascript" src="/static/js/amazeui.min.js"></script>
	<script type="text/javascript" src="/static/js/zUI.js"></script>
	<script type="text/javascript" src="/static/js/wechat.js"></script>
	<script type="text/javascript" src="/static/js/base64.js"></script>
	<script type="text/javascript">
		//三图标
		window.onload=function(){
			var conn;
			var userId;
			var userName;
			var nickName;
			var roomId="{{ .RoomId }}"
			function a(){
				var si1 = document.getElementById('si_1');
				var si2 = document.getElementById('si_2');
				var si3 = document.getElementById('si_3');
				si1.onclick=function(){
					si1.style.background="url(images/icon/head_2_1.png) no-repeat"
					si2.style.background="";
					si3.style.background="";
				};
				si2.onclick=function(){
					si2.style.background="url(images/icon/head_3_1.png) no-repeat"
					si1.style.background="";
					si3.style.background="";
				};
				si3.onclick=function(){
					si3.style.background="url(images/icon/head_4_1.png) no-repeat"
					si1.style.background="";
					si2.style.background="";
				};
			};
			function b(){
				var text = document.getElementById('input_box');
				var chat = document.getElementById('chatbox');
				var btn = document.getElementById('send');
				var talk = document.getElementById('talkbox');
				btn.onclick=function(){
					if(text.value ==''){
			            alert('不能发送空消息');
			        }else{
						
						chat.scrollTop=chat.scrollHeight;
						talk.style.background="#fff";
						text.style.background="#fff";
						conn.send(text.value);
						text.value = '';
					};
				};
			};
			a();
			b();
			function getUserInfo() {
				console.log("请求准备发送");
				$.ajax({
					type : "Get",
					url : "/api/user/info",
					dataType : "json",
					data : {},
					success : function(data) {
						if (data.code == 1001) {
							//没有登录，需要重定向
							//window.location = 
							return
						}

						if (data.code != 0) {
							alert(data.message);
							return
						}

						userId = data.data.user_id
						userName = data.data.username
						nickName = data.data.nickname
						getRoomMessage()
					},
				});
				
			}
			getUserInfo()
			function getRoomMessage() {
				console.log("请求准备发送");
				$.ajax({
					type : "Get",
					url : "/api/room/message?room_id={{ .RoomId }}",
					dataType : "json",
					data : {},
					success : function(data) {
						if (data.code == 1001) {
							//没有登录，需要重定向
							//window.location = 
							return
						}

						if (data.code != 0) {
							alert(data.message);
							return
						}

						if (data.data.length == 0) {
							return
						}
						for (var i = 0; i < data.data.length; i++) {
							var text = document.getElementById('input_box');
							var chat = document.getElementById('chatbox');
							var btn = document.getElementById('send');
							var talk = document.getElementById('talkbox');
							var style = "other"
							var message = data.data[i]
							if (message.user_id == userId) {
								style = "me"
							}
							
							chat.innerHTML += '<li class="'+style+'"><img src="'+message.image_url+'"><span>'+message.content+'</span></li>';
							chat.scrollTop=chat.scrollHeight;
						}
					},
				});
			}
			
			if (window["WebSocket"]) {
				conn = new WebSocket("ws://" + document.location.host + "/ws?room_id={{ .RoomId }}");
				conn.onclose = function (evt) {
					var item = document.createElement("div");
					item.innerHTML = "<b>Connection closed.</b>";
					appendLog(item);
				};
				conn.onmessage = function (evt) {
					//alert(evt.data);
					var obj = JSON.parse(evt.data);
            		//alert(obj.type);
					//alert(obj.data);
					if (obj.type == 1002) {
						//处理聊天信息
						
						str =  Base64.decode(obj.data); 
						console.log(str)
						chatMsg = JSON.parse(str);
						//alert(chatMsg.username);
					
						var text = document.getElementById('input_box');
						var chat = document.getElementById('chatbox');
						var btn = document.getElementById('send');
						var talk = document.getElementById('talkbox');
						var style = "other"
						if (chatMsg.user_id == userId) {
							style = "me"
						}
						chat.innerHTML += '<li class="'+style+'"><img src="'+chatMsg.image_url+'"><span>'+chatMsg.content+'</span></li>';
						chat.scrollTop=chat.scrollHeight;
						return
					}
					if (obj.type == 1003) {
						//处理用户进入房间信息
						str =  Base64.decode(obj.data); 
						console.log(str)
						onlineUserList = JSON.parse(str);
						//alert(chatMsg.username);
						//alert(onlineUserList.user_list.length)
						var user_list = document.getElementById('user_list');
						
						var online_user_count = document.getElementById('online_user_count');
						var all_user_html = '';
						for (var i = 0; i < onlineUserList.user_list.length; i++) {
							var user = onlineUserList.user_list[i];
							
							html = '<li class="user_active">'+
								'<div class="user_head"><img src="'+user.image_url+'"></div>'+
								'<div class="user_text">'+
									'<p class="user_name">'+user.username+'</p>'+
									//'<p class="user_message">我是傻逼！，金少凯牛逼！</p>'+
								'</div>'+
								//'<div class="user_time">下午 2：54</div>'+
							'</li>'
							all_user_html += html
						}
						//alert(all_user_html)
						user_list.innerHTML = all_user_html
						online_user_count.innerHTML = '在线人数：' + onlineUserList.online_user_count + '人'
						/*
						var user_list = document.getElementById('user_list');
						html = '<li class="user_active">'+
								'<div class="user_head"><img src="'+enterMsg.image_url+'"></div>'+
								'<div class="user_text">'+
									'<p class="user_name">'+enterMsg.username+'</p>'+
									//'<p class="user_message">我是傻逼！，金少凯牛逼！</p>'+
								'</div>'+
								//'<div class="user_time">下午 2：54</div>'+
							'</li>'
						user_list.innerHTML += html
						*/
					}
					
					
				};
			} else {
				var item = document.createElement("div");
				item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
				appendLog(item);
			}
		};
	</script>
	

</body></html>
{{end}}